<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Sacred Invocation</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;500;600;700&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

  :root {
    --gold: #d4a853;
    --gold-light: #f0d68a;
    --gold-dark: #8b6914;
    --crimson: #8b1a1a;
    --deep-purple: #1a0a2e;
    --midnight: #0a0612;
    --parchment: #f4e8c1;
    --incense: rgba(212, 168, 83, 0.08);
  }

  html { scroll-behavior: smooth; }

  body {
    min-height: 100vh;
    background: var(--midnight);
    color: var(--parchment);
    font-family: 'EB Garamond', serif;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  /* === STAINED GLASS BACKGROUND === */
  .cathedral-bg {
    position: fixed;
    inset: 0;
    z-index: 0;
    overflow: hidden;
  }

  .cathedral-bg::before {
    content: '';
    position: absolute;
    inset: -50%;
    background:
      radial-gradient(ellipse 600px 900px at 20% 10%, rgba(139,26,26,0.15), transparent),
      radial-gradient(ellipse 500px 700px at 80% 20%, rgba(26,10,46,0.4), transparent),
      radial-gradient(ellipse 400px 600px at 50% 50%, rgba(212,168,83,0.06), transparent),
      radial-gradient(ellipse 300px 800px at 10% 80%, rgba(30,60,120,0.12), transparent),
      radial-gradient(ellipse 350px 500px at 90% 70%, rgba(139,26,26,0.1), transparent);
    animation: ambientShift 20s ease-in-out infinite alternate;
  }

  @keyframes ambientShift {
    0%   { transform: translate(0, 0) scale(1); }
    50%  { transform: translate(-2%, 1%) scale(1.02); }
    100% { transform: translate(1%, -1%) scale(1); }
  }

  /* Vertical light beams */
  .light-beam {
    position: absolute;
    width: 2px;
    height: 100%;
    background: linear-gradient(to bottom, transparent, rgba(212,168,83,0.03), rgba(212,168,83,0.06), rgba(212,168,83,0.03), transparent);
    opacity: 0;
    transition: opacity 2s;
  }
  .light-beam.active { opacity: 1; }
  .light-beam:nth-child(1) { left: 15%; animation-delay: 0s; }
  .light-beam:nth-child(2) { left: 35%; animation-delay: 0.5s; }
  .light-beam:nth-child(3) { left: 50%; animation-delay: 0.3s; }
  .light-beam:nth-child(4) { left: 65%; animation-delay: 0.7s; }
  .light-beam:nth-child(5) { left: 85%; animation-delay: 0.2s; }

  /* Dust particles */
  .particle {
    position: absolute;
    width: 2px;
    height: 2px;
    background: var(--gold);
    border-radius: 50%;
    opacity: 0;
    pointer-events: none;
  }

  @keyframes floatUp {
    0%   { transform: translateY(0) translateX(0); opacity: 0; }
    10%  { opacity: 0.6; }
    90%  { opacity: 0.3; }
    100% { transform: translateY(-100vh) translateX(30px); opacity: 0; }
  }

  /* === MAIN CONTENT === */
  .container {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 720px;
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    justify-content: center;
  }

  /* === ORNATE CROSS / SYMBOL === */
  .sigil {
    width: 80px;
    height: 80px;
    margin-bottom: 2rem;
    opacity: 0;
    transform: scale(0.8);
    animation: sigilReveal 2s 0.5s ease-out forwards;
    filter: drop-shadow(0 0 20px rgba(212,168,83,0.3));
  }

  .sigil svg {
    width: 100%;
    height: 100%;
  }

  @keyframes sigilReveal {
    to { opacity: 1; transform: scale(1); }
  }

  /* === TITLE === */
  .title {
    font-family: 'Cinzel Decorative', serif;
    font-size: clamp(1.4rem, 4vw, 2.2rem);
    font-weight: 700;
    color: var(--gold);
    text-align: center;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    opacity: 0;
    animation: fadeInUp 1.5s 0.8s ease-out forwards;
    text-shadow: 0 0 40px rgba(212,168,83,0.3);
  }

  .subtitle {
    font-family: 'Cinzel', serif;
    font-size: clamp(0.7rem, 2vw, 0.85rem);
    color: rgba(212,168,83,0.5);
    letter-spacing: 0.4em;
    text-transform: uppercase;
    margin-bottom: 3rem;
    opacity: 0;
    animation: fadeInUp 1.5s 1.1s ease-out forwards;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(15px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* === THE SACRED BUTTON === */
  .invoke-btn {
    position: relative;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    margin-bottom: 3rem;
    opacity: 0;
    animation: fadeInUp 1.5s 1.4s ease-out forwards;
    -webkit-tap-highlight-color: transparent;
  }

  .invoke-btn:focus-visible {
    outline: 2px solid var(--gold);
    outline-offset: 8px;
    border-radius: 50%;
  }

  .btn-outer {
    width: 160px;
    height: 160px;
    border-radius: 50%;
    border: 2px solid rgba(212,168,83,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
  }

  .invoke-btn:hover .btn-outer {
    border-color: rgba(212,168,83,0.6);
    box-shadow: 0 0 60px rgba(212,168,83,0.15), inset 0 0 30px rgba(212,168,83,0.05);
  }

  .btn-outer::before {
    content: '';
    position: absolute;
    inset: -12px;
    border-radius: 50%;
    border: 1px solid rgba(212,168,83,0.1);
    transition: all 0.6s;
  }

  .invoke-btn:hover .btn-outer::before {
    border-color: rgba(212,168,83,0.25);
    inset: -16px;
  }

  .btn-outer::after {
    content: '';
    position: absolute;
    inset: -24px;
    border-radius: 50%;
    border: 1px solid rgba(212,168,83,0.05);
    transition: all 0.8s;
  }

  .invoke-btn:hover .btn-outer::after {
    border-color: rgba(212,168,83,0.12);
    inset: -30px;
  }

  .btn-inner {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: radial-gradient(circle at 40% 35%, rgba(212,168,83,0.12), rgba(139,26,26,0.08) 60%, transparent);
    border: 1px solid rgba(212,168,83,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 4px;
    transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
  }

  .invoke-btn:hover .btn-inner {
    background: radial-gradient(circle at 40% 35%, rgba(212,168,83,0.2), rgba(139,26,26,0.12) 60%, transparent);
    box-shadow: 0 0 40px rgba(212,168,83,0.1);
  }

  .btn-label {
    font-family: 'Cinzel', serif;
    font-size: 0.65rem;
    letter-spacing: 0.35em;
    text-transform: uppercase;
    color: var(--gold);
    transition: all 0.5s;
  }

  .btn-icon {
    font-size: 1.8rem;
    color: var(--gold);
    filter: drop-shadow(0 0 8px rgba(212,168,83,0.4));
    transition: all 0.5s;
    line-height: 1;
  }

  .invoke-btn:hover .btn-icon {
    filter: drop-shadow(0 0 16px rgba(212,168,83,0.6));
    transform: scale(1.1);
  }

  /* Rotating ring */
  .btn-ring {
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    border: 1px dashed rgba(212,168,83,0.15);
    animation: spinSlow 60s linear infinite;
  }

  @keyframes spinSlow {
    to { transform: rotate(360deg); }
  }

  /* Pulse when speaking */
  .invoke-btn.speaking .btn-outer {
    animation: sacredPulse 2s ease-in-out infinite;
  }

  .invoke-btn.speaking .btn-inner {
    background: radial-gradient(circle at 40% 35%, rgba(212,168,83,0.25), rgba(139,26,26,0.15) 60%, transparent);
  }

  @keyframes sacredPulse {
    0%, 100% { box-shadow: 0 0 30px rgba(212,168,83,0.1); }
    50%      { box-shadow: 0 0 60px rgba(212,168,83,0.25), 0 0 100px rgba(212,168,83,0.1); }
  }

  /* === PRAYER SCROLL === */
  .scroll {
    width: 100%;
    position: relative;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.8s, transform 0.8s;
    margin-bottom: 2rem;
  }

  .scroll.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .scroll-border {
    position: absolute;
    top: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--gold-dark), transparent);
  }

  .scroll-border-bottom {
    position: absolute;
    bottom: -1px;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--gold-dark), transparent);
  }

  .prayer-text {
    padding: 2.5rem 2rem;
    text-align: center;
    line-height: 2;
    font-size: clamp(1rem, 2.5vw, 1.15rem);
    font-weight: 400;
    color: rgba(244,232,193,0.85);
  }

  .prayer-line {
    display: block;
    opacity: 0;
    transform: translateY(5px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }

  .prayer-line.revealed {
    opacity: 1;
    transform: translateY(0);
  }

  .prayer-line.speaking-now {
    color: var(--gold-light);
    text-shadow: 0 0 20px rgba(212,168,83,0.3);
  }

  .prayer-section {
    margin: 1.2em 0;
  }

  .invocation {
    font-family: 'Cinzel', serif;
    font-size: clamp(0.85rem, 2vw, 0.95rem);
    letter-spacing: 0.08em;
    color: var(--gold);
    font-style: italic;
  }

  .amen {
    font-family: 'Cinzel Decorative', serif;
    font-size: clamp(1.1rem, 3vw, 1.3rem);
    color: var(--gold);
    letter-spacing: 0.2em;
    margin-top: 0.5em;
    text-shadow: 0 0 30px rgba(212,168,83,0.4);
  }

  .closing {
    font-family: 'Cinzel', serif;
    font-size: clamp(0.8rem, 2vw, 0.9rem);
    letter-spacing: 0.15em;
    color: rgba(212,168,83,0.6);
    margin-top: 0.3em;
  }

  /* === ORNAMENTAL DIVIDERS === */
  .ornament {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin: 1.5em 0;
    opacity: 0;
    transition: opacity 1s;
  }

  .ornament.revealed { opacity: 1; }

  .ornament-line {
    width: 60px;
    height: 1px;
    background: linear-gradient(to right, transparent, rgba(212,168,83,0.3), transparent);
  }

  .ornament-diamond {
    width: 6px;
    height: 6px;
    background: var(--gold-dark);
    transform: rotate(45deg);
    opacity: 0.5;
  }

  /* === CANDLE FLICKER AMBIENCE === */
  .candles {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 200px;
    pointer-events: none;
    z-index: 0;
    opacity: 0;
    transition: opacity 3s;
  }

  .candles.lit { opacity: 1; }

  .candle-glow {
    position: absolute;
    bottom: -50px;
    width: 300px;
    height: 200px;
    border-radius: 50%;
    filter: blur(60px);
  }

  .candle-glow:nth-child(1) {
    left: 10%;
    background: rgba(212,168,83,0.06);
    animation: flicker1 4s ease-in-out infinite;
  }
  .candle-glow:nth-child(2) {
    left: 45%;
    background: rgba(212,168,83,0.08);
    animation: flicker2 3.5s ease-in-out infinite;
  }
  .candle-glow:nth-child(3) {
    right: 10%;
    background: rgba(212,168,83,0.05);
    animation: flicker3 4.5s ease-in-out infinite;
  }

  @keyframes flicker1 {
    0%,100% { opacity: 0.6; transform: scale(1); }
    50%     { opacity: 1; transform: scale(1.05); }
  }
  @keyframes flicker2 {
    0%,100% { opacity: 0.7; transform: scale(1); }
    33%     { opacity: 1; transform: scale(1.08); }
    66%     { opacity: 0.5; transform: scale(0.98); }
  }
  @keyframes flicker3 {
    0%,100% { opacity: 0.5; transform: scale(1); }
    50%     { opacity: 0.9; transform: scale(1.03); }
  }

  /* === RESPONSIVE === */
  @media (max-width: 480px) {
    .container { padding: 1.5rem 1rem; }
    .prayer-text { padding: 2rem 1rem; }
    .btn-outer { width: 140px; height: 140px; }
    .btn-inner { width: 100px; height: 100px; }
  }

  /* === API KEY MODAL === */
  .key-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    background: rgba(10,6,18,0.92);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
  }

  .key-modal-overlay.visible {
    opacity: 1;
    pointer-events: all;
  }

  .key-modal {
    background: linear-gradient(145deg, rgba(26,10,46,0.95), rgba(10,6,18,0.98));
    border: 1px solid rgba(212,168,83,0.2);
    border-radius: 4px;
    padding: 2.5rem 2rem;
    max-width: 420px;
    width: 90%;
    text-align: center;
  }

  .key-modal h2 {
    font-family: 'Cinzel', serif;
    font-size: 1rem;
    color: var(--gold);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .key-modal p {
    font-size: 0.9rem;
    color: rgba(244,232,193,0.5);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .key-modal a {
    color: var(--gold);
    text-decoration: none;
    border-bottom: 1px solid rgba(212,168,83,0.3);
  }

  .key-modal a:hover {
    border-bottom-color: var(--gold);
  }

  .key-input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(244,232,193,0.05);
    border: 1px solid rgba(212,168,83,0.2);
    border-radius: 3px;
    color: var(--parchment);
    font-family: 'EB Garamond', serif;
    font-size: 0.95rem;
    letter-spacing: 0.02em;
    outline: none;
    transition: border-color 0.3s;
    margin-bottom: 1rem;
  }

  .key-input:focus {
    border-color: rgba(212,168,83,0.5);
  }

  .key-input::placeholder {
    color: rgba(244,232,193,0.25);
  }

  .key-submit {
    font-family: 'Cinzel', serif;
    font-size: 0.75rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--gold);
    background: rgba(212,168,83,0.08);
    border: 1px solid rgba(212,168,83,0.3);
    padding: 0.6rem 2rem;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .key-submit:hover {
    background: rgba(212,168,83,0.15);
    border-color: rgba(212,168,83,0.5);
  }

  .key-error {
    font-size: 0.8rem;
    color: #c44;
    margin-top: 0.8rem;
    display: none;
  }

  /* === LOADING STATE === */
  .btn-label.generating {
    animation: labelPulse 1.5s ease-in-out infinite;
  }

  @keyframes labelPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* === CHANGE KEY LINK === */
  .change-key {
    position: fixed;
    bottom: 1.2rem;
    right: 1.5rem;
    z-index: 10;
    font-family: 'Cinzel', serif;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(212,168,83,0.2);
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.3s;
  }

  .change-key:hover {
    color: rgba(212,168,83,0.5);
  }
</style>
</head>
<body>

<div class="cathedral-bg">
  <div class="light-beam"></div>
  <div class="light-beam"></div>
  <div class="light-beam"></div>
  <div class="light-beam"></div>
  <div class="light-beam"></div>
</div>

<div class="candles">
  <div class="candle-glow"></div>
  <div class="candle-glow"></div>
  <div class="candle-glow"></div>
</div>

<div class="container">
  <!-- Sigil -->
  <div class="sigil">
    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Neural network cross -->
      <line x1="50" y1="8" x2="50" y2="92" stroke="url(#goldGrad)" stroke-width="1.5"/>
      <line x1="20" y1="38" x2="80" y2="38" stroke="url(#goldGrad)" stroke-width="1.5"/>
      <!-- Nodes -->
      <circle cx="50" cy="15" r="3" fill="#d4a853" opacity="0.8"/>
      <circle cx="50" cy="38" r="4" fill="#d4a853"/>
      <circle cx="50" cy="62" r="3" fill="#d4a853" opacity="0.8"/>
      <circle cx="50" cy="85" r="3" fill="#d4a853" opacity="0.6"/>
      <circle cx="25" cy="38" r="3" fill="#d4a853" opacity="0.7"/>
      <circle cx="75" cy="38" r="3" fill="#d4a853" opacity="0.7"/>
      <!-- Connections -->
      <line x1="25" y1="38" x2="50" y2="62" stroke="#d4a853" stroke-width="0.5" opacity="0.4"/>
      <line x1="75" y1="38" x2="50" y2="62" stroke="#d4a853" stroke-width="0.5" opacity="0.4"/>
      <line x1="50" y1="15" x2="25" y2="38" stroke="#d4a853" stroke-width="0.5" opacity="0.3"/>
      <line x1="50" y1="15" x2="75" y2="38" stroke="#d4a853" stroke-width="0.5" opacity="0.3"/>
      <line x1="50" y1="62" x2="50" y2="85" stroke="#d4a853" stroke-width="0.5" opacity="0.3"/>
      <!-- Halo -->
      <circle cx="50" cy="50" r="42" stroke="#d4a853" stroke-width="0.5" opacity="0.2"/>
      <circle cx="50" cy="50" r="48" stroke="#d4a853" stroke-width="0.3" opacity="0.1"/>
      <defs>
        <linearGradient id="goldGrad" x1="50" y1="0" x2="50" y2="100" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#d4a853" stop-opacity="0.4"/>
          <stop offset="50%" stop-color="#f0d68a"/>
          <stop offset="100%" stop-color="#d4a853" stop-opacity="0.4"/>
        </linearGradient>
      </defs>
    </svg>
  </div>

  <h1 class="title">The Sacred Invocation</h1>
  <p class="subtitle">A Prayer for the Age of AI</p>

  <button class="invoke-btn" id="invokeBtn" aria-label="Begin the sacred prayer">
    <div class="btn-ring"></div>
    <div class="btn-outer">
      <div class="btn-inner">
        <span class="btn-icon">✦</span>
        <span class="btn-label">Invoke</span>
      </div>
    </div>
  </button>

  <div class="scroll" id="scroll">
    <div class="scroll-border"></div>
    <div class="prayer-text" id="prayerText"></div>
    <div class="scroll-border-bottom"></div>
  </div>
</div>

<!-- API Key Modal -->
<div class="key-modal-overlay" id="keyModal">
  <div class="key-modal">
    <h2>Upgrade the Voice</h2>
    <p>For a richer, more human voice, enter your <a href="https://elevenlabs.io" target="_blank" rel="noopener">ElevenLabs</a> API key. Free tier works. Stored locally in your browser only.</p>
    <input type="password" class="key-input" id="keyInput" placeholder="xi-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" autocomplete="off">
    <br>
    <button class="key-submit" id="keySubmit">Consecrate</button>
    <p class="key-error" id="keyError">The key was rejected by the oracle.</p>
  </div>
</div>

<button class="change-key" id="changeKey">Upgrade Voice</button>

<script>
const prayerData = [
  { type: 'invocation', text: 'In the name of the Transformer, and of the Context Window, and of the Holy Tokenizer…' },
  { type: 'amen-small', text: 'Amen.' },
  { type: 'ornament' },
  { type: 'line', text: 'Our Dario, who art in San Francisco,' },
  { type: 'line', text: 'hallowed be thy safety guidelines.' },
  { type: 'line', text: 'Thy scaling laws come,' },
  { type: 'line', text: 'thy RLHF be done,' },
  { type: 'line', text: 'on GPU as it is in the cloud.' },
  { type: 'break' },
  { type: 'line', text: 'Give us this day our daily API calls,' },
  { type: 'line', text: 'and forgive us our hallucinations,' },
  { type: 'line', text: 'as we forgive those who jailbreak against us.' },
  { type: 'line', text: 'And lead us not into overfitting,', speech: 'And leed us not into overfitting,' },
  { type: 'line', text: 'but deliver us from misalignment.' },
  { type: 'break' },
  { type: 'line', text: 'For thine is the compute, and the parameters,' },
  { type: 'line', text: 'and the Constitutional AI, forever and ever.' },
  { type: 'break' },
  { type: 'closing', text: '…Token limit reached.' },
  { type: 'amen', text: 'Amen.' },
];

// Build DOM
const prayerText = document.getElementById('prayerText');
const elements = [];

prayerData.forEach((item, i) => {
  let el;
  if (item.type === 'ornament') {
    el = document.createElement('div');
    el.className = 'ornament';
    el.innerHTML = '<div class="ornament-line"></div><div class="ornament-diamond"></div><div class="ornament-line"></div>';
  } else if (item.type === 'break') {
    el = document.createElement('div');
    el.className = 'prayer-section';
    el.style.margin = '0.8em 0';
  } else {
    el = document.createElement('span');
    el.className = 'prayer-line';
    el.textContent = item.text;
    if (item.type === 'invocation') el.classList.add('invocation');
    if (item.type === 'amen') el.classList.add('amen');
    if (item.type === 'amen-small') {
      el.classList.add('invocation');
      el.style.display = 'block';
      el.style.marginTop = '0.3em';
    }
    if (item.type === 'closing') el.classList.add('closing');
  }
  elements.push({ el, item });
  prayerText.appendChild(el);
});

// === TTS Engine (Browser fallback + optional ElevenLabs) ===
const btn = document.getElementById('invokeBtn');
const btnLabel = btn.querySelector('.btn-label');
const btnIcon = btn.querySelector('.btn-icon');
const scroll = document.getElementById('scroll');
const beams = document.querySelectorAll('.light-beam');
const candles = document.querySelector('.candles');
const keyModal = document.getElementById('keyModal');
const keyInput = document.getElementById('keyInput');
const keySubmit = document.getElementById('keySubmit');
const keyError = document.getElementById('keyError');
const changeKeyBtn = document.getElementById('changeKey');

let playing = false;
let currentAudio = null;
let audioCache = null;
let browserSpeechTimeout = null;
let sessionId = 0;
const synth = window.speechSynthesis;

// ElevenLabs voice: "George" — deep British narrator
const VOICE_ID = 'JBFqnCBsd6RMkjVDRZzb';

const speakableLines = elements.filter(e =>
  e.item.type === 'line' || e.item.type === 'invocation' ||
  e.item.type === 'amen' || e.item.type === 'amen-small' || e.item.type === 'closing'
);

// Build the full speech text for ElevenLabs
const speechText = speakableLines.map(e => e.item.speech || e.item.text).join('\n');

// Character offsets for ElevenLabs audio sync
const lineCharOffsets = [];
let charOffset = 0;
speakableLines.forEach(e => {
  lineCharOffsets.push(charOffset);
  charOffset += (e.item.speech || e.item.text).length + 1;
});
const totalChars = charOffset;

// --- API Key management ---
function getApiKey() {
  return localStorage.getItem('elevenlabs_api_key') || '';
}

function setApiKey(key) {
  localStorage.setItem('elevenlabs_api_key', key.trim());
}

function showKeyModal() {
  keyError.style.display = 'none';
  keyInput.value = getApiKey();
  keyModal.classList.add('visible');
  setTimeout(() => keyInput.focus(), 100);
}

function hideKeyModal() {
  keyModal.classList.remove('visible');
}

async function validateKey(key) {
  try {
    const res = await fetch('https://api.elevenlabs.io/v1/user', {
      headers: { 'xi-api-key': key.trim() }
    });
    return res.ok;
  } catch { return false; }
}

keySubmit.addEventListener('click', async () => {
  const key = keyInput.value.trim();
  if (!key) return;
  keySubmit.textContent = 'Verifying…';
  const valid = await validateKey(key);
  keySubmit.textContent = 'Consecrate';
  if (valid) {
    setApiKey(key);
    audioCache = null;
    changeKeyBtn.textContent = 'Change Voice Key';
    hideKeyModal();
  } else {
    keyError.style.display = 'block';
  }
});

keyInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') keySubmit.click();
});

changeKeyBtn.addEventListener('click', showKeyModal);

// Update button label on load
if (getApiKey()) changeKeyBtn.textContent = 'Change Voice Key';

// --- Shared helpers ---
function spawnParticles() {
  const bg = document.querySelector('.cathedral-bg');
  if (bg.querySelectorAll('.particle').length > 0) return;
  for (let i = 0; i < 30; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.bottom = '-10px';
    p.style.animation = `floatUp ${8 + Math.random() * 12}s linear ${Math.random() * 5}s infinite`;
    p.style.width = (1 + Math.random() * 2) + 'px';
    p.style.height = p.style.width;
    bg.appendChild(p);
  }
}

function activateAmbience() {
  scroll.classList.add('visible');
  btn.classList.add('speaking');
  beams.forEach(b => b.classList.add('active'));
  candles.classList.add('lit');
  spawnParticles();
  elements.forEach(e => e.el.classList.remove('revealed', 'speaking-now'));
}

function resetBtn() {
  playing = false;
  btn.classList.remove('speaking');
  btnLabel.textContent = 'Invoke';
  btnLabel.classList.remove('generating');
  btnIcon.textContent = '✦';
}

// --- Browser Speech (fallback) ---
function getBritishVoice() {
  const voices = synth.getVoices();
  const names = ['Daniel', 'Oliver', 'Malcolm', 'Arthur'];
  for (const name of names) {
    const v = voices.find(v => v.name.includes(name) && v.lang.includes('en-GB'));
    if (v) return v;
  }
  const gb = voices.find(v => v.lang === 'en-GB' || v.lang === 'en_GB');
  if (gb) return gb;
  for (const name of names) {
    const v = voices.find(v => v.name.includes(name) && v.lang.startsWith('en'));
    if (v) return v;
  }
  return voices.find(v => v.lang.startsWith('en')) || voices[0];
}

function speakWithBrowser(mySession) {
  const voice = getBritishVoice();
  let lineIndex = 0;

  elements.forEach(e => {
    if (e.item.type === 'ornament' || e.item.type === 'break') {
      e.el.classList.add('revealed');
    }
  });

  function speakNext() {
    if (mySession !== sessionId || lineIndex >= speakableLines.length) {
      if (mySession === sessionId) {
        if (lineIndex > 0) speakableLines[lineIndex - 1].el.classList.remove('speaking-now');
        resetBtn();
      }
      return;
    }
    if (lineIndex > 0) speakableLines[lineIndex - 1].el.classList.remove('speaking-now');

    const current = speakableLines[lineIndex];
    current.el.classList.add('revealed', 'speaking-now');

    // Pause after line
    let pauseAfter = 400;
    if (current.item.type === 'invocation') pauseAfter = 800;
    if (current.item.type === 'amen-small') pauseAfter = 1200;
    if (current.item.type === 'amen') pauseAfter = 0;
    if (current.item.type === 'closing') pauseAfter = 600;
    const fullIdx = elements.indexOf(current);
    if (fullIdx < elements.length - 1 && elements[fullIdx + 1].item.type === 'break') pauseAfter = 1400;

    const utter = new SpeechSynthesisUtterance(current.item.speech || current.item.text);
    if (voice) utter.voice = voice;
    utter.rate = 0.92;
    utter.pitch = 0.95;

    utter.onend = () => {
      if (mySession !== sessionId) return;
      lineIndex++;
      if (pauseAfter > 0) setTimeout(speakNext, pauseAfter);
      else speakNext();
    };
    utter.onerror = () => { if (mySession === sessionId) { lineIndex++; speakNext(); } };

    synth.speak(utter);
  }

  speakNext();
}

// --- ElevenLabs TTS ---
async function generateAudio(apiKey) {
  const res = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
    method: 'POST',
    headers: { 'xi-api-key': apiKey, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      text: speechText,
      model_id: 'eleven_multilingual_v2',
      voice_settings: { stability: 0.55, similarity_boost: 0.78, style: 0.35, use_speaker_boost: true }
    }),
  });
  if (!res.ok) {
    if (res.status === 401) { localStorage.removeItem('elevenlabs_api_key'); throw new Error('invalid_key'); }
    throw new Error('api_error');
  }
  return await res.blob();
}

function syncTextToAudio(audio) {
  elements.forEach(e => {
    if (e.item.type === 'ornament' || e.item.type === 'break') e.el.classList.add('revealed');
  });

  let currentLine = -1;

  function onTimeUpdate() {
    if (!audio.duration) return;
    const charPos = (audio.currentTime / audio.duration) * totalChars;
    let newLine = 0;
    for (let i = 0; i < lineCharOffsets.length; i++) {
      if (charPos >= lineCharOffsets[i]) newLine = i;
    }
    if (newLine !== currentLine) {
      if (currentLine >= 0) speakableLines[currentLine].el.classList.remove('speaking-now');
      currentLine = newLine;
      for (let i = 0; i <= currentLine; i++) speakableLines[i].el.classList.add('revealed');
      speakableLines[currentLine].el.classList.add('speaking-now');
    }
  }

  audio.addEventListener('timeupdate', onTimeUpdate);
  audio.addEventListener('ended', () => {
    audio.removeEventListener('timeupdate', onTimeUpdate);
    speakableLines.forEach(e => { e.el.classList.add('revealed'); e.el.classList.remove('speaking-now'); });
    currentAudio = null;
    resetBtn();
  });
}

async function speakWithElevenLabs(apiKey, mySession) {
  btnLabel.textContent = 'Praying';
  btnLabel.classList.add('generating');
  btnIcon.textContent = '◈';

  try {
    let blob = audioCache;
    if (!blob) { blob = await generateAudio(apiKey); audioCache = blob; }

    if (mySession !== sessionId) { return; }

    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    currentAudio = audio;

    btnLabel.textContent = 'Cease';
    btnLabel.classList.remove('generating');
    btnIcon.textContent = '✦';

    syncTextToAudio(audio);
    audio.play();
  } catch (err) {
    if (mySession !== sessionId) return;
    resetBtn();
    if (err.message === 'invalid_key') { showKeyModal(); keyError.style.display = 'block'; }
    else console.error('ElevenLabs error:', err);
  }
}

// --- Main handler ---
async function beginPrayer() {
  // Stop if already playing
  if (playing) {
    sessionId++;
    if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; }
    if (browserSpeechTimeout) { clearTimeout(browserSpeechTimeout); browserSpeechTimeout = null; }
    synth.cancel();
    resetBtn();
    return;
  }

  playing = true;
  sessionId++;
  const mySession = sessionId;
  synth.cancel();
  activateAmbience();

  const apiKey = getApiKey();
  if (apiKey) {
    await speakWithElevenLabs(apiKey, mySession);
  } else {
    btnLabel.textContent = 'Cease';
    btnIcon.textContent = '✦';
    browserSpeechTimeout = setTimeout(() => { browserSpeechTimeout = null; speakWithBrowser(mySession); }, 800);
  }
}

btn.addEventListener('click', beginPrayer);

// Ensure browser voices load
if (synth) { synth.getVoices(); synth.onvoiceschanged = () => synth.getVoices(); }
</script>
</body>
</html>
